<?php

/**
 * @file
 * Read nodes in a variety of vocies and, seperately, languages/accents
 *
 *
 */

/**
 * Implements hook_help().
 */

function webspeech_tts_help($path, $arg) {
  switch ($path) {
    case 'admin/help#webspeech_tts':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Webspeech TTS module allows users with the <em>Administer site configuration</em> permission to quickly and easily change voices and languages(accents) associated with content in a node.  Like the API itself, it is experimental and not intended for enterprise usage.  Clear both the Drupal AND browser cache frequently when testing. </p>');
      $output .= '<h3>' . t('How to use') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Enabling on a node') . '</dt>';
      $output .= '<dd>' . t("You may enable WebspeechTTS on a node in edit mode in the 'WebspeechTTS' tab. In order to place the Play-Pause-Cancel buttons adjancent to the node, locate the 'WebspeechTTS' block. ") . '</dd>';
      $output .= '</dl>';
      return $output;
  }
}

/**
 * Implements hook_menu().
 */

drupal_static_reset('sites/all/modules/custom/webspeech_tts/webspeech_tts.js?v=1');

function webspeech_tts_menu() {
  $items = array();
  $items['node/%/webspeech_tts'] = array(
    'title' => t('Webspeech TTS for Chrome'),
    'description' => t('Option to Read Node Content Out Loud'),
    //'type' => MENU_LOCAL_TASK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('webspeech_tts_form'),
    // disabled for now
    //'access callback' => 'webspeech_tts_access_tab',
    //'access arguments' => array('Create Webspeech subscriptions', 1),'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/content/webspeech_tts'] = array(
    'title' => t('Webspeech TTS for Chrome'),
    'description' => t('Administer Webspeech TTS'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('webspeech_tts_admin_settings_form'),
    'access arguments' => array('administer webspeech_tts settings'),
    'file' => 'webspeech_tts.admin.inc',
    'type' => MENU_NORMAL_ITEM,
    );
  return $items;
}

/**
 * Implements hook_form().
 */

function webspeech_tts_form($form, &$form_state){

  $tts_lang_only = variable_get('webspeech_tts_lang_only');
  $tts_voice = variable_get('webspeech_tts_voice');

  $tts_vol = variable_get('webspeech_tts_volume', 'volume');
  $tts_rate = variable_get('webspeech_tts_rate', 'rate');
  $tts_pitch = variable_get('webspeech_tts_pitch', 'pitch');
    //drupal_set_message('the lang is: '. $tts_lang_only .' and the voice is: '. $tts_voice);
    //drupal_set_message($message);
  drupal_add_js(array('webspeech_tts' => array('tts_lang_only_js' => $tts_lang_only)), 'setting');
  drupal_add_js(array('webspeech_tts' => array('tts_voice_js' => $tts_voice)), 'setting');
  drupal_add_js(array('webspeech_tts' => array('tts_volume_js' => $tts_vol)), 'setting');
  drupal_add_js(array('webspeech_tts' => array('tts_rate_js' => $tts_rate)), 'setting');
  drupal_add_js(array('webspeech_tts' => array('tts_pitch_js' => $tts_pitch)), 'setting');

  $path_args = explode('/', current_path());  
  $node = node_load((int)$path_args[1]);
  $node_content_to_js = $node->body['und'][0]['value'];

  drupal_static_reset('sites/all/modules/custom/webspeech_tts/webspeech_tts.js?v=1');
  drupal_add_js(array('webspeech_tts' => array('proof_of_concept' => $node_content_to_js)), 'setting');
  drupal_add_js('sites/all/modules/custom/webspeech_tts/webspeech_tts.js?v=1');

  print '<pre>';
 //var_dump(get_defined_vars());
  print '</pre>';

  $form['read_text'] = array(
      '#type' => 'submit',
      '#value' => t('Read Text Aloud'),
      '#action' => url('#'),
      '#id' => 'read_text',
      '#attributes' => array('onclick' => 'return (false);'),
  );

  $form['pause_button'] = array(
    '#type' => 'button',
    '#value' => t('Pause'),
    '#action' => url('#'),
    //'#submit' => array('stop_submit_function'),
    '#id' => 'pause_button',
    '#attributes' => array('onclick' => 'return (false);'),
  );

  $form['cancel_button'] = array(
    '#type' => 'button',
    '#value' => t('Cancel'),
    '#action' => url('#'),
    //'#submit' => array('stop_submit_function'),
    '#id' => 'cancel_button',
    '#attributes' => array('onclick' => 'return (false);'),
  );

  return $form;

}

/**
 * Implements hook_form_FORM_ID_alter().
 */

function webspeech_tts_form_node_form_alter(&$form, $form_state) {
  $node = $form['#node'];
  $types = variable_get('webspeech_tts_types', array());
  if (!empty($types[$node->type]) && user_access('administer webspeech_tts settings')) {
    $form['webspeech_tts'] = array(
      '#title' => t('webspeech_tts'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      '#group' => 'additional_settings',
    );
    $form['webspeech_tts']['webspeech_tts_enabled'] = array(
      '#title' => t('Enable WebspeechTTS'),
      '#type' => 'checkbox',
      '#default_value' => isset($node->webspeech_tts_enabled) ? 
$node->webspeech_tts_enabled : FALSE,
    );
  }
}

/**
 * Implements hook_VERB_node_enabled().
 */

function webspeech_tts_get_node_enabled($nid){
  if (is_numeric($nid)) {
    $result = db_query("SELECT nid FROM {webspeech_tts_enabled}
      WHERE nid = :nid", array('nid' => $nid))->fetchField();
    if ($result) {
      return TRUE;
    }   
  }
  return FALSE;
}
function webspeech_tts_set_node_enabled($nid){
  if (is_numeric($nid) &! webspeech_tts_get_node_enabled($nid)) {
      db_insert('webspeech_tts_enabled')
        ->fields(array('nid' => $nid))
        ->execute();
  }
}
function webspeech_tts_delete_node_enabled($nid) {
  if (is_numeric($nid)) {
    db_delete('webspeech_tts_enabled')
      ->condition('nid', $nid)
      ->execute();
  }
}
function webspeech_tts_node_load($nodes, $types) {
  foreach ($nodes as $nid => $node) {
    $node->webspeech_tts_enabled = webspeech_tts_get_node_enabled($node->nid);
  }
}
function webspeech_tts_node_insert($node) {
  if ($node->webspeech_tts_enabled) {
    webspeech_tts_set_node_enabled($node->nid);
  }
}
function webspeech_tts_node_update($node) {
  webspeech_tts_delete_node_enabled($node->nid);
  if ($node->webspeech_tts_enabled) {
    webspeech_tts_set_node_enabled($node->nid);
  }
}
function webspeech_tts_node_delete($node) {
  webspeech_tts_delete_node_enabled($node->nid);
}
function webspeech_tts_access_tab($permission, $nid) {
    return webspeech_tts_get_node_enabled($nid) && user_access($permission);
}

/* Conditional to toggle voices and languages which are incompatible */

$the_switch = variable_get('voice_or_lang+only');

//drupal_set_message('This is the switch:'.$the_switch);

if ($the_switch == 'voice'){
  variable_set('webspeech_tts_lang_only','en-US');
}

else if ($the_switch == 'lang_only'){ 
  variable_set('webspeech_tts_voice','0');
}

function webspeech_tts_block_info(){
  $blocks = array();
  $blocks['webspeech_tts'] = array(
      'info' => t('Webspeech TTS'),
      );
  return $blocks;
}


/**
 * Implements hook_block_view().
 */

function webspeech_tts_block_view($delta='')
{
  switch($delta) {
    case 'webspeech_tts':

     if (arg(0) == 'node' && is_numeric(arg(1)) && webspeech_tts_get_node_enabled(arg(1))){
      $nid = arg(1);

      $form =  drupal_get_form('webspeech_tts_form');

      $block = array('content' => theme('webspeech_tts_block', array('form' => drupal_render($form))),
      );

      return $block;
    }

      break;
   }
   
 }
 
/**
 * Implements hook_theme().
 */

 function webspeech_tts_theme() {
  $theme = array();
  $theme['webspeech_tts_block'] = array(
    'variables' => array(
      'form' => '',
    ),
    'template' => 'webspeech_tts-block',
  );
  return $theme;
}

/**
 * Implements hook_permission().
 */

function webspeech_tts_permission() {
  return array(
    'administer Webspeech TTS' => array(
      'title' => t('Administer Webspeech TTS'),
      'description' => t('Perform administration tasks for Webspeech TTS.'),
    ),
  );
}

/**
 * Implements hook_uninstall().


function webspeech_tts_uninstall() {
 variable_del('webspeech_tts_lang_only');
 variable_del('webspeech_tts_voice');
 variable_del('webspeech_tts_volume');
 variable_del('webspeech_tts_rate');
 variable_del('webspeech_tts_pitch');
 variable_del('voice_or_lang+only');
}
 */